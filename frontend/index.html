<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AbsenteismoController - GrupoBiomed</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="/static/css/main.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-chart-line"></i> AbsenteismoController
                </div>
                <div class="sidebar-subtitle">GrupoBiomed</div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="/" class="nav-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/clientes" class="nav-item">
                    <i class="fas fa-building"></i>
                    <span>üè¢ Clientes</span>
                </a>
                <a href="/apresentacao" class="nav-item">
                    <i class="fas fa-tv"></i>
                    <span>üìä Apresenta√ß√£o</span>
                </a>
                <a href="/upload" class="nav-item">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>üì§ Upload Planilha</span>
                </a>
                <a href="/dados_powerbi" class="nav-item">
                    <i class="fas fa-table"></i>
                    <span>üìã Meus Dados</span>
                </a>
                <a href="/funcionarios" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>üë• Funcion√°rios</span>
                </a>
                <a href="/comparativos" class="nav-item">
                    <i class="fas fa-balance-scale"></i>
                    <span>‚öñÔ∏è Comparativos</span>
                </a>
                <a href="/relatorios" class="nav-item">
                    <i class="fas fa-file-alt"></i>
                    <span>üìÑ Relat√≥rios</span>
                </a>
                <a href="/configuracoes" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>‚öôÔ∏è Configura√ß√µes</span>
                </a>
            </nav>
            
            <div style="padding: 20px; margin-top: auto; border-top: 1px solid #e0e0e0;">
                <div id="userInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        <i class="fas fa-user"></i> <span id="userName">Usu√°rio</span>
                    </div>
                    <button onclick="logout()" class="btn btn-secondary" style="width: 100%; padding: 8px; font-size: 12px;">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <h1 class="header-title">Dashboard</h1>
                <div class="header-actions" style="display: flex; align-items: center; gap: 16px; position: relative;">
                    <div style="position: relative; cursor: pointer;" onclick="toggleAlertasDropdown(event)">
                        <i class="fas fa-bell" style="color: #666; font-size: 20px;"></i>
                        <span id="alertasBadge" class="alertas-badge" style="display: none; position: absolute; top: -8px; right: -8px; background: #f44336; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white;">0</span>
                    </div>
                    <div id="alertasDropdown" class="alertas-dropdown" style="display: none; position: absolute; top: calc(100% + 8px); right: 0; width: 400px; max-width: 90vw; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 500px; overflow-y: auto;">
                        <div style="padding: 12px; border-bottom: 1px solid #eee; font-weight: 600; font-size: 14px; background: #f8f9fa;">
                            <i class="fas fa-bell"></i> Alertas (<span id="alertasCount">0</span>)
                        </div>
                        <div id="alertasList" style="padding: 8px;">
                            <div style="text-align: center; padding: 20px; color: #999;">
                                <i class="fas fa-spinner fa-spin"></i> Carregando...
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-icon" onclick="recarregarDados()">
                        <i class="fas fa-sync"></i>
                    </button>
                    <a href="/upload" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        Novo Upload
                    </a>
                </div>
            </header>
            
            <div class="content">
                <!-- Insights Autom√°ticos -->
                <div id="insightsSection" style="display: none; margin-bottom: 24px;">
                    <h2 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-lightbulb" style="color: #FF9800;"></i>
                        An√°lises e Insights
                    </h2>
                    <div id="insightsContainer" style="display: grid; gap: 16px;"></div>
                </div>
                
                <!-- Filters -->
                <div class="filters">
                    <div class="filters-grid" style="display: grid; grid-template-columns: 140px 140px 1fr 1fr 120px; gap: 12px; align-items: end;">
                        <div class="filter-group" style="margin: 0;">
                            <label class="filter-label" style="font-size: 13px; margin-bottom: 6px;">M√™s In√≠cio</label>
                            <input type="month" id="mesInicio" class="filter-input" style="padding: 8px 10px;">
                        </div>
                        <div class="filter-group" style="margin: 0;">
                            <label class="filter-label" style="font-size: 13px; margin-bottom: 6px;">M√™s Fim</label>
                            <input type="month" id="mesFim" class="filter-input" style="padding: 8px 10px;">
                        </div>
                        <!-- Funcion√°rios -->
                        <div class="filter-group" style="margin: 0;">
                            <label class="filter-label" style="font-size: 13px; margin-bottom: 6px;">Funcion√°rios</label>
                            <div class="multiselect-dropdown" style="position: relative;">
                                <div class="multiselect-trigger" onclick="toggleDropdown('funcionarios')" style="padding: 8px 10px; border: 1px solid #dee2e6; border-radius: 4px; background: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; min-height: 38px;">
                                    <span id="funcionariosText" style="color: #6c757d; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;">Selecione...</span>
                                    <i class="fas fa-chevron-down" style="color: #6c757d; transition: transform 0.3s; margin-left: 8px; flex-shrink: 0;" id="funcionariosIcon"></i>
                                </div>
                                <div id="dropdownFuncionarios" class="multiselect-dropdown-content" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #dee2e6; border-radius: 4px; margin-top: 4px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                    <div style="padding: 8px; border-bottom: 1px solid #dee2e6; display: flex; gap: 8px;">
                                        <button type="button" onclick="selecionarTodos('funcionarios')" style="flex: 1; padding: 6px; border: 1px solid #1a237e; color: #1a237e; background: white; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            Todos
                                        </button>
                                        <button type="button" onclick="desselecionarTodos('funcionarios')" style="flex: 1; padding: 6px; border: 1px solid #6c757d; color: #6c757d; background: white; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            Nenhum
                                        </button>
                                    </div>
                                    <div id="checkboxesFuncionarios" style="padding: 8px;">
                                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                                            <i class="fas fa-spinner fa-spin"></i> Carregando...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Setores -->
                        <div class="filter-group" style="margin: 0;">
                            <label class="filter-label" style="font-size: 13px; margin-bottom: 6px;">Setores</label>
                            <div class="multiselect-dropdown" style="position: relative;">
                                <div class="multiselect-trigger" onclick="toggleDropdown('setores')" style="padding: 8px 10px; border: 1px solid #dee2e6; border-radius: 4px; background: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; min-height: 38px;">
                                    <span id="setoresText" style="color: #6c757d; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;">Selecione...</span>
                                    <i class="fas fa-chevron-down" style="color: #6c757d; transition: transform 0.3s; margin-left: 8px; flex-shrink: 0;" id="setoresIcon"></i>
                                </div>
                                <div id="dropdownSetores" class="multiselect-dropdown-content" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #dee2e6; border-radius: 4px; margin-top: 4px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                    <div style="padding: 8px; border-bottom: 1px solid #dee2e6; display: flex; gap: 8px;">
                                        <button type="button" onclick="selecionarTodos('setores')" style="flex: 1; padding: 6px; border: 1px solid #1a237e; color: #1a237e; background: white; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            Todos
                                        </button>
                                        <button type="button" onclick="desselecionarTodos('setores')" style="flex: 1; padding: 6px; border: 1px solid #6c757d; color: #6c757d; background: white; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            Nenhum
                                        </button>
                                    </div>
                                    <div id="checkboxesSetores" style="padding: 8px;">
                                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                                            <i class="fas fa-spinner fa-spin"></i> Carregando...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="filter-group" style="margin: 0;">
                            <button class="btn btn-primary" onclick="aplicarFiltros()" style="width: 100%; padding: 8px 16px; font-size: 13px;">
                                <i class="fas fa-filter"></i>
                                Aplicar
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- KPI Cards -->
                <div class="cards-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Dias Perdidos</div>
                                <div class="card-value" id="cardDiasPerdidos">-</div>
                            </div>
                            <div class="card-icon warning">
                                <i class="fas fa-calendar-times"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Horas Perdidas</div>
                                <div class="card-value" id="cardHorasPerdidas">-</div>
                            </div>
                            <div class="card-icon danger">
                                <i class="fas fa-hourglass-half"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Grid - Layout Otimizado -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                    <!-- TOP CIDs -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">TOP 10 Doen√ßas mais Frequentes</h3>
                            <p class="chart-subtitle">Principais causas de afastamento (exceto exames/doa√ß√µes)</p>
                        </div>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas id="chartCids"></canvas>
                        </div>
                    </div>
                    
                    <!-- Evolu√ß√£o Mensal -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Evolu√ß√£o Mensal - √öltimos 12 Meses</h3>
                            <p class="chart-subtitle">Tend√™ncia de atestados e dias perdidos</p>
                        </div>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas id="chartEvolucao"></canvas>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
                    <!-- TOP Setores -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">TOP 5 Setores</h3>
                            <p class="chart-subtitle">Setores com mais atestados</p>
                        </div>
                        <div class="chart-wrapper" style="height: 280px;">
                            <canvas id="chartSetores"></canvas>
                        </div>
                    </div>
                    
                    <!-- Distribui√ß√£o por G√™nero -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Por G√™nero</h3>
                            <p class="chart-subtitle">Masculino vs Feminino</p>
                        </div>
                        <div class="chart-wrapper" style="height: 280px;">
                            <canvas id="chartGenero"></canvas>
                        </div>
                    </div>
                    
                    <!-- Dias por Doen√ßa -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Dias por Doen√ßa</h3>
                            <p class="chart-subtitle">Total de dias perdidos</p>
                        </div>
                        <div class="chart-wrapper" style="height: 280px;">
                            <canvas id="chartMediaCid"></canvas>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                    <!-- Dias Perdidos por Funcion√°rios -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Dias Perdidos por Funcion√°rios</h3>
                            <p class="chart-subtitle">TOP 10 funcion√°rios com mais dias perdidos</p>
                        </div>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas id="chartFuncionariosDias"></canvas>
                        </div>
                    </div>
                    
                    <!-- Evolu√ß√£o por Setor -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Evolu√ß√£o de Dias Perdidos por Setor</h3>
                            <p class="chart-subtitle">Tend√™ncia dos principais setores</p>
                        </div>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas id="chartEvolucaoSetor"></canvas>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                    <!-- Escalas com mais Atestados -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Escalas (Hor√°rios) com mais Atestados</h3>
                            <p class="chart-subtitle">TOP 10 escalas com maior incid√™ncia</p>
                        </div>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas id="chartEscalas"></canvas>
                        </div>
                    </div>
                    
                    <!-- Motivos de Incid√™ncia -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Motivos de Incid√™ncia com mais Atestados</h3>
                            <p class="chart-subtitle">Distribui√ß√£o percentual dos motivos</p>
                        </div>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas id="chartMotivos"></canvas>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                    <!-- Dias Perdidos por Centro de Custo (Setor) -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Dias Perdidos por Centro de Custo</h3>
                            <p class="chart-subtitle">TOP 10 setores</p>
                        </div>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas id="chartCentroCusto"></canvas>
                        </div>
                    </div>
                    
                    <!-- Distribui√ß√£o de Dias por Atestado -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Distribui√ß√£o de Dias por Atestado</h3>
                            <p class="chart-subtitle">Histograma de frequ√™ncia</p>
                        </div>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas id="chartDistribuicaoDias"></canvas>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                    <!-- M√©dia de Dias por CID -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">M√©dia de Dias por CID</h3>
                            <p class="chart-subtitle">Doen√ßas com maior m√©dia de dias</p>
                        </div>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas id="chartMediaCidDias"></canvas>
                        </div>
                    </div>
                    
                    <!-- Dias Perdidos por Setor e G√™nero -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Dias Perdidos por Setor e G√™nero</h3>
                            <p class="chart-subtitle">Comparativo entre g√™neros por setor</p>
                        </div>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas id="chartSetorGenero"></canvas>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                    <!-- Comparativo Dias vs Horas -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Comparativo: Dias vs Horas Perdidas</h3>
                            <p class="chart-subtitle">Por setor</p>
                        </div>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas id="chartComparativoDiasHoras"></canvas>
                        </div>
                    </div>
                    
                    <!-- Frequ√™ncia de Atestados por Funcion√°rio -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Frequ√™ncia de Atestados por Funcion√°rio</h3>
                            <p class="chart-subtitle">Distribui√ß√£o de funcion√°rios por n√∫mero de atestados</p>
                        </div>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas id="chartFrequenciaAtestados"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="/static/js/menu.js"></script>
    <script src="/static/js/dashboard.js"></script>
    <script>
        // Fecha dropdowns ao clicar fora
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.multiselect-dropdown')) {
                document.querySelectorAll('.multiselect-dropdown-content').forEach(dd => {
                    dd.style.display = 'none';
                });
                document.querySelectorAll('.multiselect-dropdown i').forEach(icon => {
                    icon.style.transform = 'rotate(0deg)';
                });
            }
        });
        
        // Carrega alertas do menu
        async function carregarAlertasMenu() {
            try {
                const mesInicio = document.getElementById('mesInicio')?.value || '';
                const mesFim = document.getElementById('mesFim')?.value || '';
                
                let url = '/api/alertas?client_id=1';
                if (mesInicio) url += `&mes_inicio=${encodeURIComponent(mesInicio)}`;
                if (mesFim) url += `&mes_fim=${encodeURIComponent(mesFim)}`;
                
                const response = await fetch(url);
                if (!response.ok) return;
                
                const data = await response.json();
                const total = data.total || 0;
                window.alertasData = data.alertas || [];
                
                const badge = document.getElementById('alertasBadge');
                if (badge) {
                    if (total > 0) {
                        badge.textContent = total;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar alertas:', error);
            }
        }
        
        // Toggle dropdown de alertas
        function toggleAlertasDropdown(event) {
            event.stopPropagation();
            event.preventDefault();
            const dropdown = document.getElementById('alertasDropdown');
            if (!dropdown) return;
            
            // Fecha outros dropdowns
            document.querySelectorAll('.alertas-dropdown').forEach(dd => {
                if (dd !== dropdown) dd.style.display = 'none';
            });
            
            if (dropdown.style.display === 'none' || !dropdown.style.display) {
                dropdown.style.display = 'block';
                renderizarAlertasDropdown();
            } else {
                dropdown.style.display = 'none';
            }
        }
        
        // Renderiza alertas no dropdown
        function renderizarAlertasDropdown() {
            const container = document.getElementById('alertasList');
            const countEl = document.getElementById('alertasCount');
            const alertas = window.alertasData || [];
            
            if (countEl) countEl.textContent = alertas.length;
            
            if (!container) return;
            
            if (alertas.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Nenhum alerta</div>';
                return;
            }
            
            const severidades = {'alta': 3, 'media': 2, 'baixa': 1};
            const alertasOrdenados = [...alertas].sort((a, b) => 
                (severidades[b.severidade] || 0) - (severidades[a.severidade] || 0)
            );
            
            container.innerHTML = alertasOrdenados.map(alerta => {
                const icone = alerta.severidade === 'alta' ? 'fa-exclamation-circle' : 
                             alerta.severidade === 'media' ? 'fa-exclamation-triangle' : 'fa-info-circle';
                const cor = alerta.severidade === 'alta' ? '#f44336' : 
                           alerta.severidade === 'media' ? '#ff9800' : '#2196f3';
                
                let acaoBtn = '';
                if (alerta.tipo === 'funcionario_alto_absenteismo' || alerta.tipo === 'funcionario_frequente') {
                    acaoBtn = `<a href="/perfil_funcionario?nome=${encodeURIComponent(alerta.dados.nome)}" style="display: inline-block; margin-top: 8px; padding: 4px 12px; background: #1a237e; color: white; border-radius: 4px; text-decoration: none; font-size: 12px;">
                        <i class="fas fa-user-circle"></i> Ver Perfil
                    </a>`;
                }
                
                return `
                    <div style="padding: 12px; border-bottom: 1px solid #f0f0f0;">
                        <div style="display: flex; align-items: flex-start; gap: 8px;">
                            <i class="fas ${icone}" style="color: ${cor}; margin-top: 4px; font-size: 16px;"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 13px; color: #333; margin-bottom: 4px;">${alerta.titulo}</div>
                                <div style="font-size: 12px; color: #666; line-height: 1.4;">${alerta.mensagem}</div>
                                ${acaoBtn}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Fecha dropdown ao clicar fora
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('alertasDropdown');
            const headerActions = document.querySelector('.header-actions');
            if (dropdown && headerActions && !headerActions.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // Carrega alertas ap√≥s carregar dashboard
        setTimeout(carregarAlertasMenu, 2000);
        setInterval(carregarAlertasMenu, 5 * 60 * 1000);
    </script>
    <script src="/static/js/auth.js"></script>
</body>
</html>
